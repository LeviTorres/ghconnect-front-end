<h1><strong>Nueva solicitud de Seguros y Fianzas</strong></h1>
<form autocomplete="off" [formGroup]="finaceForm">
  <div class="row d-flex align-items-center">
    <div class="col-4">
      <h2><strong>Datos de poliza</strong></h2>
    </div>
    <div class="col-8 row">
      <div class="col-6">
        <label>Fecha de creacion</label>
        <mat-form-field class="w-100" appearance="outline">
          <input
            matInput
            [matDatepicker]="picker1"
            formControlName="creation_date"
            placeholder="Selecciona una fecha"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="picker1"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker1></mat-datepicker>
        </mat-form-field>
      </div>
      <div class="col-6">
        <label>Fecha de emision</label>
        <mat-form-field class="w-100" appearance="outline">
          <input
            matInput
            [matDatepicker]="picker4"
            placeholder="Selecciona una fecha"
            formControlName="issue_date"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="picker4"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker4></mat-datepicker>
          <mat-error
          *ngIf="finaceForm.controls['issue_date'].hasError('required')"
          >
            Campo requerido
          </mat-error>
        </mat-form-field>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-3">
      <label>Numero de poliza</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          placeholder="Escribe el codigo de empleado"
          formControlName="key_policy"
        />
        <mat-error
        *ngIf="finaceForm.controls['key_policy'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <label>Tipo de poliza</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="policy_type"
          placeholder="Selecciona el tipo de poliza"
        />
        <mat-error
        *ngIf="finaceForm.controls['policy_type'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <label>Ceco</label>
      <mat-form-field class="w-100" appearance="outline">
        <mat-select
          matInput
          placeholder="Escribe el Ceco"
          formControlName="ceco"
        >
          <mat-option *ngFor="let item of cecos" [value]="item._id">{{item.
            key_ceco_business}} - {{
            item.name_short
          }}</mat-option>
        </mat-select>
        <mat-error
        *ngIf="finaceForm.controls['ceco'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <label>Empresa</label>
      <mat-form-field class="w-100" appearance="outline">
        <mat-select
        matInput
        placeholder="Nombre empresa"
        formControlName="business"
      >
        <mat-option *ngFor="let item of business" [value]="item._id"> {{
          item.name_short
        }}</mat-option>
      </mat-select>
      </mat-form-field>
    </div>
  </div>
  <div class="row d-flex align-items-center">
    <div class="col-3">
      <div>
        <label>Ordenante</label>
        <mat-form-field class="w-100" appearance="outline">
          <input
          type="text"
          class="w-100"
          matInput
          formControlName="payer"
          [matAutocomplete]="search1"
          placeholder="Escribe al ordenante"
          />
          <mat-autocomplete
            autoActiveFirstOption
            #search1="matAutocomplete"
            [displayWith]="displayFnPayer"
          >
            <mat-option value="" *ngIf="!finaceForm.controls['payer'].value">
              Escribe algo...
            </mat-option>
            <div *ngIf="finaceForm.controls['payer'].value">
              <mat-option
                *ngFor="let option of filteredOptionsPayer"
                [value]="option"
              >
                {{ option.name }}</mat-option
              >
            </div>
          </mat-autocomplete>
          <mat-error
          *ngIf="finaceForm.controls['payer'].hasError('required')"
          >
            Campo requerido
          </mat-error>
        </mat-form-field>
      </div>
    </div>
    <div class="col-3">
      <div>
        <label>Beneficiario</label>
        <mat-form-field class="w-100" appearance="outline">
          <input
          matInput
          formControlName="beneficiary"
          placeholder="Escribe el nombre del beneficiario"
        />
        <mat-error
        *ngIf="finaceForm.controls['beneficiary'].hasError('required')"
        >
          Campo requerido
        </mat-error>
        </mat-form-field>
      </div>
    </div>
    <div class="col-3">
      <div>
        <label>Valor contrato principal</label>
        <mat-form-field class="w-100" appearance="outline">
          <input
          matInput
          type="number"
          placeholder="$000,000,000.00"
          formControlName="main_contract_value"
          />
          <mat-error
          *ngIf="finaceForm.controls['main_contract_value'].hasError('required')"
          >
            Campo requerido
          </mat-error>
        </mat-form-field>
      </div>
    </div>
    <div class="col-3">
      <div>
        <label>Divisa contrato principal</label>
        <mat-form-field class="w-100" appearance="outline">
          <mat-select
          matInput
          formControlName="divisa_main_value"
          placeholder="Selecciona la divisa del contrato"
          >
            <mat-option *ngFor="let item of divisas" [value]="item._id">{{item.abbreviation_divisa}}</mat-option>
          </mat-select>
          <mat-error
          *ngIf="finaceForm.controls['divisa_main_value'].hasError('required')"
          >
            Campo requerido
          </mat-error>
        </mat-form-field>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-3">
      <label>Suma garantizada</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          type="number"
          formControlName="guaranteed_sum"
          placeholder="$000,000,000.00"
        />
        <mat-error
        *ngIf="finaceForm.controls['guaranteed_sum'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <label>Divisa de suma garantizada</label>
      <mat-form-field class="w-100" appearance="outline">
        <mat-select
        matInput
        formControlName="divisa_guaranteed_sum"
        placeholder="Selecciona la divisa del contrato"
        >
          <mat-option *ngFor="let item of divisas" [value]="item._id">{{item.abbreviation_divisa}}</mat-option>
        </mat-select>
        <mat-error
        *ngIf="finaceForm.controls['divisa_guaranteed_sum'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-6">
      <label>Valor de equivalencia contrato principal</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="equivalent_value"
          placeholder="Equivalente al 7% (Siete/cien por ciento) del contrato principal"
        />
      </mat-form-field>
    </div>
  </div>
  <div class="row">
    <div class="col-3">
      <label>Inicio vigencia</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
        matInput
        [matDatepicker]="picker3"
        formControlName="start_date"
        placeholder="Selecciona una fecha"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="picker3"
        ></mat-datepicker-toggle>
        <mat-datepicker #picker3></mat-datepicker>
        <mat-error
        *ngIf="finaceForm.controls['start_date'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <label>Fin vigencia</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
        matInput
        [matDatepicker]="picker2"
        formControlName="finish_date"
        placeholder="Selecciona una fecha"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="picker2"
        ></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
        <mat-error
        *ngIf="finaceForm.controls['finish_date'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-6">
      <label>Vigencia de poliza</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="policy_validity"
        />
      </mat-form-field>
    </div>
  </div>
  <div class="row">
    <div class="col-8">
      <label>Objeto del seguro/fianza</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="insurance_object"
          placeholder="Escribe el objeto del beneficiario"
        />
        <mat-error
        *ngIf="finaceForm.controls['insurance_object'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-4">
      <label>Procedimiento de ejecucion</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="process_execution"
          placeholder="Renovable, irrevocable y primer req."
        />
        <mat-error
        *ngIf="finaceForm.controls['process_execution'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
  </div>
  <div class="row">
    <div class="col-3">
      <label>Prima a pagar</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="premium_pay"
          type="number"
          placeholder="$000,000,000.00"
        />
        <mat-error
        *ngIf="finaceForm.controls['premium_pay'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <label>Condiciones de pago</label>
      <mat-form-field class="w-100" appearance="outline">
        <input
          matInput
          formControlName="payment_conditions"
          placeholder="Escribe la condicion de pago"
        />
        <mat-error
        *ngIf="finaceForm.controls['payment_conditions'].hasError('required')"
        >
          Campo requerido
        </mat-error>
      </mat-form-field>
    </div>
  </div>
  <div class="d-flex">
    <div>
      <h1 class="my-3"><strong>Documento</strong></h1>
    </div>
    <div>
      <button class="btn-primary mx-3"  mat-raised-button>
        Anadir documento
      </button>
    </div>
  </div>
  <div class="row">
    <h1 class="my-3"><strong>Notificaciones</strong></h1>
  </div>
  <div class="row mb-5">
    <div class="col-6">
      <div class="table-responsive" *ngIf="!addUser">
        <table class="table text-nowrap">
          <thead>
            <tr>
              <th class="last">Autorizador</th>
              <th class="last">Requerido</th>
              <th class="last">Status</th>
              <th class="last" *ngIf="finaceRequest && finaceRequest.status === 'TOSEND'">Acciones</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let authorizer of authorizers; index as i">
              <td>
                <span>{{ getEmailAuthorizer(authorizer.user) }}</span>
              </td>
              <td class="text-center">
                <mat-checkbox
                  class="mb-4"
                  disabled
                  [checked]="authorizer.required"
                ></mat-checkbox>
              </td>
              <td>
                <p *ngIf="authorizer.status === '' || !authorizer.status" class="mb-3">POR ENVIAR</p>
                <p *ngIf="authorizer.status === 'SEND'" class="mb-3">ENVIADO</p>
                <p *ngIf="authorizer.status === 'CANCELLED'" class="mb-3">CANCELADO</p>
                <p *ngIf="authorizer.status === 'ACCEPTED'" class="mb-3">ACEPTADO</p>
              </td>
              <td *ngIf="finaceRequest && finaceRequest.status === 'TOSEND'">
                <!--<i class="fa fa-edit me-4" (click)="openDialogEditDivisa(divisa)"></i>-->
                <i class="fa fa-trash" (click)="delete(i)"></i>
              </td>
              <td></td>
            </tr>
            <td
              style="color: var(--tblr-blue); cursor: pointer"
              class="text-center py-2"
              (click)="addRow()"
              *ngIf="finaceRequest && finaceRequest.status === 'TOSEND'"
            >
              Añadir autorizador
            </td>
          </tbody>
        </table>
      </div>
      <div *ngIf="addUser" class="card p-4">
        <form
          (ngSubmit)="registerUser()"
          autocomplete="off"
          [formGroup]="userForm"
        >
          <div class="row">
            <div class="col-8">
              <label
                >Escribe el nombre o correo electronico del autorizador</label
              >
              <mat-form-field class="w-100" appearance="outline">
                <input
                  type="text"
                  class="w-100"
                  matInput
                  formControlName="user"
                  [matAutocomplete]="search"
                  placeholder="Ingresa un usuario"
                />
                <mat-autocomplete
                  autoActiveFirstOption
                  #search="matAutocomplete"
                  [displayWith]="displayFn"
                >
                  <mat-option value="" *ngIf="!userForm.controls['user'].value">
                    Escribe algo...
                  </mat-option>
                  <mat-option
                    value="{{ userForm.controls['user'].value }}"
                    (click)="createUser(userForm.controls['user'].value)"
                    *ngIf="userForm.controls['user'].value && !validate_user"
                  >
                    Crear usuario {{ userForm.controls["user"].value }}
                  </mat-option>
                  <div *ngIf="userForm.controls['user'].value">
                    <mat-option
                      *ngFor="let option of filteredOptions"
                      [value]="option"
                    >
                      {{ option.email }} ({{ option.name }}
                      {{ option.last_name }})</mat-option
                    >
                  </div>
                </mat-autocomplete>
                <mat-error
                  *ngIf="userForm.controls['user'].hasError('required')"
                >
                  Campo requerido
                </mat-error>
              </mat-form-field>
            </div>
            <div class="col-3 d-flex flex-column text-center">
              <label>Requerido</label>
              <mat-checkbox formControlName="required"></mat-checkbox>
            </div>
            <div class="col-1 d-flex justify-content-end">
              <i class="fa-light fa-xmark fa" (click)="returnTable()"></i>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <label>Escribele un mensaje al autorizador</label>
              <mat-form-field class="w-100" appearance="outline">
                <textarea
                  matInput
                  formControlName="message"
                  placeholder="Describe tu solicitud"
                ></textarea>
              </mat-form-field>
            </div>
          </div>
          <div class="row d-flex justify-content-center">
            <button class="btn-primary w-75" mat-raised-button>
              Añadir autorizador
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="col-6">
      <div class="card p-3">
        <span class="mb-2"><strong>Actividad reciente</strong></span>
        <div *ngIf="this.users.length > 0"  style="max-height: 200px; overflow-y: auto;">
          <p *ngFor="let item of activities">
            {{ item.date | date : "dd/MM/yyyy h:mm a" }} -
            {{ getUser(item.user)!.name }} {{ getUser(item.user)!.last_name }} -
            {{ item.action }}
          </p>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center" *ngIf="finaceRequest">
    <button
      class="btn-primary mx-3"
      (click)="registerFinace()"
      mat-raised-button
      *ngIf="finaceRequest.status === 'TOSEND'"
    >
      Guardar solicitud
    </button>
    <button class="btn-primary mx-3" (click)="sendRequest()" mat-raised-button *ngIf="finaceRequest.status === 'TOSEND'">
      Enviar solicitud
    </button>
    <button
      *ngIf="
        finaceRequest.status !== 'TOSEND' && finaceRequest.status !== 'SEND'
      "
      class="btn-primary mx-3"
      (click)="updatedToSend()"
      mat-raised-button
    >
      Cambiar solicitud Por enviar
    </button>
  </div>
</form>
